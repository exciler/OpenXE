(function(r){var C=function(F,y){var p={WAITING:"waiting",UPLOADING:"uploading",FINISHED:"finished",FAILURE:"failure"},t={options:{chunkSize:6291456,upload:{url:null,view:"standard",formData:{}},filesContainer:"#chunked-upload-files",fileComplete:function(e){}},storage:{$fileInput:null,$filesContainer:null,$filesList:null,uploads:{}},init:function(e,n){if(!t.isFileApiAvailable()){alert("Die HTML5 File-API wird von ihrem Browser nicht unterstützt. Bitte verwenden sie einen moderneren Browser.");return}if(t.options=r.extend({},t.options,n),typeof t.options.upload.url>"u"||t.options.upload.url===null)throw"Initialisierung nicht möglich. Upload-URL fehlt.";(typeof t.options.upload.formData>"u"||t.options.upload.formData===null)&&(t.options.upload.formData={});var a=r(e);if(a.length!==1)throw"File-Input Element wurde nicht gefunden.";if(!a.is("input[type=file]")){alert('Init-Element muss ein "input"-Element vom Typ "file" sein.');return}a.on("change",t.onSelectFilesEventHandler),t.storage.$fileInput=a,t.createFilesContainer()},onSelectFilesEventHandler:function(e){var n=e.target.files;r.each(n,function(l,f){t.addFileUpload(f)});var a=r(this);a.replaceWith(a.val("").clone(!0))},addFileUpload:function(e){var n=t.generateRandomId(),a=t.formatBytes(e.size),l={id:n,file:e,reader:new FileReader,status:p.WAITING,elements:{$progressBar:null,$statusInfo:null,$actionCell:null}},f=r("<a>");f.attr("href","#").text("Entfernen"),f.addClass("chuncked-removefile-trigger").addClass("button"),f.on("click",function(g){g.preventDefault();var m=r(this),w=m.parents("tr"),v=w.data("fileId");t.removeFile(v)});var u=r("<a>");u.attr("href","#").text("Hochladen"),u.addClass("chuncked-startupload-trigger").addClass("button"),u.on("click",function(g){g.preventDefault();var m=r(this),w=m.parents("tr"),v=w.data("fileId");t.startUpload(v)});var h=r("<progress>").attr("min","0").attr("max","100").val(0),o=r("<tr>").attr("id",n).data("fileId",n);if(t.options.upload.view==="sidebar"){var i=r("<td>").appendTo(o),d=r("<table>").appendTo(i);r("<td>").addClass("filename").html(e.name).appendTo(r("<tr>").appendTo(d)).before("<td>Dateiname:</td>"),r("<td>").addClass("filesize").html(a).appendTo(r("<tr>").appendTo(d)).before("<td>Gr&ouml;&szlig;e:</td>"),r("<td>").addClass("fileprogress").html(h).appendTo(r("<tr>").appendTo(d)).before("<td>Fortschritt:</td>");var c=r("<td>").addClass("filestatus").html("Bereit zum Hochladen").appendTo(r("<tr>").appendTo(d)).before("<td>Status:</td>"),s=r("<td>").addClass("fileaction").appendTo(r("<tr>").data("fileId",n).appendTo(d))}else{r("<td>").addClass("filename").html(e.name).appendTo(o),r("<td>").addClass("filesize").html(a).appendTo(o),r("<td>").addClass("fileprogress").html(h).appendTo(o);var c=r("<td>").addClass("filestatus").html("Bereit zum Hochladen").appendTo(o),s=r("<td>").addClass("fileaction").appendTo(o)}s.append(f),s.append(u),o.appendTo(t.storage.$filesList),l.elements.$progressBar=h,l.elements.$statusInfo=c,l.elements.$actionCell=s,t.storage.uploads[n]=l,t.storage.$filesContainer.show(),t.storage.$filesContainer.find("table").show()},removeFile:function(e){var n=r("#"+e);if(n.length===0){alert('Can not remove file upload. Element "#'+e+'" not found.');return}t.storage.uploads.hasOwnProperty(e)&&t.storage.uploads[e].status!==p.UPLOADING&&(n.remove(),delete t.storage.uploads[e])},startUpload:function(e){if(t.storage.uploads.hasOwnProperty(e)){var n=t.storage.uploads[e];t.startSingleUpload(n)}},startSingleUpload:function(e){if(e!==null){var n=e.id;if(typeof n>"u")throw"Upload fehlgeschlagen. Unique-ID is missing.";var a=r("#"+n),l=a.find(".filestatus");l.html("Bitte warten..."),e.elements.$progressBar.val(0),t.uploadFileChunk(e,0)}},uploadFileChunk:function(e,n){var a=t.options.chunkSize;if(a<10240){t.displayUploadError(e.id,"ChunkSize ist zu gering (<= 10KB). Upload nicht möglich.");return}n===0&&(a=102400);var l=n+a+1,f=e.file.slice(n,l),u=e.id;if(typeof u>"u")throw"Upload fehlgeschlagen. Unique-ID is missing.";e.status=p.UPLOADING,e.elements.$statusInfo.html("Hochladen..."),e.elements.$actionCell.html(""),e.reader.onloadend=function(h){if(h.target.readyState===FileReader.DONE){var o=t.options.upload.formData;o.file_data=h.target.result,o.file_name=e.file.name,o.file_type=e.file.type,o.file_size=e.file.size,o.file_id=e.id,o.file_offset=n,e.xhr=r.ajax({url:t.options.upload.url,type:"POST",dataType:"json",cache:!1,data:o,error:function(i,d,c){var s="Unbekannter Fehler #21: "+c;d==="abort"&&(s="Upload abgebrochen"),d==="error"&&(s="Unbekannter Server-Fehler"),i.hasOwnProperty("responseJSON")&&i.responseJSON.hasOwnProperty("error")&&(s="Server-Fehler: "+i.responseJSON.error),e.elements.$statusInfo.html("<strong>"+s+"</strong>"),e.elements.$progressBar.val(null)},success:function(i){if(i.hasOwnProperty("success")&&i.success===!1){e.elements.$progressBar.val(null),e.elements.$statusInfo.html("<strong>Server-Fehler: "+i.error+"</strong>");return}if(!i.hasOwnProperty("file")&&!i.file.hasOwnProperty("bytes")){alert("Fehlerhafte Antwort vom Server. #1");return}if(i.file.bytes===!1){alert("Fehlerhafte Antwort vom Server. #2");return}var d=i.file.bytes,c=n+d,s=e.file.size,g=Math.floor(c/s*100);if(e.elements.$progressBar.val(g),i.hasOwnProperty("uploadLimit")&&typeof i.uploadLimit=="number"&&i.uploadLimit>0){var m=Math.floor(i.uploadLimit/100*95),w=t.calculateBase64SizeFromRawSize(t.options.chunkSize);if(m<w){var v=t.calculateRawSizeFromBase64Size(m);t.options.chunkSize=v,console.warn("ChunkedUpload: PHP upload limit is "+i.uploadLimit+" bytes."),console.warn("ChunkedUpload: Chunk size set to "+v+" bytes.")}}l<s?t.uploadFileChunk(e,l):t.finishUpload(e.id)}})}},e.reader.readAsDataURL(f)},finishUpload:function(e){if(t.storage.uploads.hasOwnProperty(e)){var n=t.storage.uploads[e];n.elements.$statusInfo.html("Upload erfolgreich"),n.elements.$actionCell.html(""),n.status=p.FINISHED;var a=new I(n.id,n.file.name,n.file.type,n.file.size);t.options.fileComplete(a)}},displayUploadError:function(e,n){if(t.storage.uploads.hasOwnProperty(e)){var a=t.storage.uploads[e];a.elements.$statusInfo.html("Upload-Fehler: "+n),a.elements.$actionCell.html(""),a.status=p.FAILURE}},createFilesContainer:function(){var e="<table>";t.options.upload.view==="sidebar"?e+="<thead><th></th><th></th><tbody></tbody></table>":e+='<thead><th align="left">Dateiname</th><th>Gr&ouml;&szlig;e</th><th>Fortschritt</th><th>Status</th><th>Aktionen</th></tr></thead><tbody></tbody></table>';var n=r(e).hide(),a=r(t.options.filesContainer);a.length===0&&(a=r("<div>").insertAfter(t.storage.$fileInput)),a.append(n),a.addClass("chunked-file-upload-container"),t.storage.$filesContainer=a,t.storage.$filesList=n.find("tbody")},isFileApiAvailable:function(){return typeof window.File<"u"&&typeof window.FileList<"u"&&typeof window.FileReader<"u"},generateRandomId:function(){return"chunked_upload_"+Math.floor(Math.random()*Math.floor(9999999999))},formatBytes:function(e){var n=parseInt(e,10);if(n===0)return"0&nbsp;Bytes";var a=["Bytes","KB","MB","GB","TB"],l=Math.floor(Math.log(n)/Math.log(1024)),f=(n/Math.pow(1024,l)).toFixed(1)+"";return f.replace(".",",")+"&nbsp;"+a[l]},calculateBase64SizeFromRawSize:function(e){return Math.floor(e/3*4)},calculateRawSizeFromBase64Size:function(e){return Math.floor(e/4*3)}},I=function(e,n,a,l){this.id=e,this.name=n,this.type=a,this.size=l};return t.init(F,y),{}};r.fn.chunkedUpload=function(F){return this.each(function(){var y=r(this);if(!y.data("chunkedUpload")){var p=new C(this,F);y.data("chunkedUpload",p)}})}})(jQuery);
