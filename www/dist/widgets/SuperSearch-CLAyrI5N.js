var p=function(i){var e={config:{inputBuffer:300},storage:{$input:null,$overlay:null,$details:null,$results:null,$lastUpdate:null,debounceBuffer:null,hasResults:!1,isOpen:!1},init:function(){e.storage.$input=i("#supersearch-input"),e.storage.$input.length!==0&&e.registerEvents()},registerEvents:function(){e.storage.$input.on("keyup.SuperSearch",e.onKeyUpSearchInput),e.storage.$input.on("focus.SuperSearch",e.onFocusSearchInput),i(document).bind("keydown",function(t){e.storage.$overlay!==null&&e.storage.isOpen===!0&&t.keyCode===27&&e.hideOverlay()})},getOverlay:function(){return(typeof e.storage.$overlay>"u"||e.storage.$overlay===null)&&(e.storage.$overlay=e.createOverlay(),e.storage.$details=e.storage.$overlay.find("section.detail"),e.storage.$results=e.storage.$overlay.find("section.result"),e.storage.$lastUpdate=e.storage.$overlay.find("section.last-update")),e.storage.$overlay},showOverlay:function(){var t=e.getOverlay();t.show(),e.storage.isOpen=!0,e.showDetails()},hideOverlay:function(){e.getOverlay().hide(),e.storage.isOpen=!1},createOverlay:function(){var t="#supersearch-overlay";if(i(t).length>0)return i(t);var r='<span id="supersearch-icon-close" class="icon icon-close"></span><div class="result-wrapper"><section class="empty-message">Keine Suchergebnisse gefunden</section><section class="error-message"></section><section class="result"></section><section class="last-update"></section></div><div class="detail-wrapper"><section class="detail"></section></div>',n=t.substr(1),a=i("<div>").attr("id",n).addClass("supersearch-overlay").html(r);return a.off("click.SuperSearch","#supersearch-icon-close"),a.on("click.SuperSearch","#supersearch-icon-close",function(s){s.preventDefault(),e.hideOverlay()}),a.hide(),a.appendTo("#header"),e.storage.isOpen=!1,a},onKeyUpSearchInput:function(t){t.preventDefault();var r=[9,13,16,17,18,20,27,37,38,39,40];if(i.inArray(t.keyCode,r)===-1){var n=this;e.debounce(function(){var a=i(n).val();e.fetchSearchResults(a).then(e.renderSearchResults)},e.config.inputBuffer)}},onFocusSearchInput:function(t){t.preventDefault(),e.storage.$overlay!==null&&e.storage.hasResults!==!1&&e.showOverlay()},fetchSearchResults:function(t){return typeof t!="string"&&(t=""),i.ajax({url:"index.php?module=supersearch&action=ajax&cmd=search",method:"post",dataType:"json",data:{search_query:t},error:function(r,n,a){var s="SuperSearch - Unbekannter Fehler #31: "+a;if(n==="error"&&(s="SuperSearch - Unbekannter Server-Fehler beim Laden der Such-Ergebnisse: ",s+=a),r.hasOwnProperty("responseJSON")&&r.responseJSON.hasOwnProperty("error")&&(s="SuperSearch - Server-Fehler beim Laden der Such-Ergebnisse: ",s+=r.responseJSON.error,r.responseJSON.hasOwnProperty("data")&&r.responseJSON.data==="index-empty")){e.showErrorMessage("Fehler: "+r.responseJSON.error);return}alert(s)}})},renderSearchResults:function(t){var r=e.getOverlay(),n=r.find("section.result");if(n.html(""),t.length===0||!t.hasOwnProperty("data")){n.html("Fehler: Suche hat fehlerhaftes Ergebnis geliefert."),e.storage.hasResults=!1,e.hideResults();return}if(t.data===null){e.storage.hasResults=!1,e.hideOverlay();return}if(t.data.hasOwnProperty("last_index_update_formatted"))if(t.data.last_index_update_formatted!==null){var a=t.data.last_index_update_formatted;e.storage.$lastUpdate.text("Such-Index vom "+a).show()}else e.storage.$lastUpdate.text("").hide();var s=t.data.count,o=t.data.results;if(s===0){e.storage.hasResults=!1,e.showEmptyResults();return}e.storage.$details.html(""),Object.keys(o).forEach(function(l){var u=o[l],d=e.buildGroupResult(u.key,u.title,u.items);n.append(d)}),e.storage.hasResults=!0,e.showResults(),e.showOverlay()},buildGroupResult:function(t,r,n){if(n.length!==0){typeof r>"u"&&(r="Ergebnis");var a=i('<div class="result-group">'),s=i('<ul class="result-list">'),o=i('<li class="result-head">').html(r);return s.append(o),n.forEach(function(l){l.group=t;var u=l.type!==null?l.type:"default",d;switch(u){case"default":default:d=e.buildDefaultItemResult(l);break}s.append(d)}),a.append(s),a}},buildDefaultItemResult:function(t){var r=t.hasOwnProperty("subtitle")&&typeof t.subtitle=="string",n=t.hasOwnProperty("additionalInfos")&&typeof t.additionalInfos=="object"&&t.additionalInfos!==null,a='<span class="title-main">'+t.title+"</span>",s=r?'<span class="title-sub">'+t.subtitle+"</span>":"",o='<span class="title">'+a+s+"</span>";n&&(o+='<span class="caption">',i.each(t.additionalInfos,function(d,c){o+='<span class="additional">'+c+"</span>"}),o+="</span>");var l=i("<li>").addClass("result-item"),u=i("<a>").attr("href",t.link).html(o);return u.appendTo(l),u.on("click",function(d){d.preventDefault(),e.renderItemDetails(t)}),l},renderItemDetails:function(t){e.fetchItemDetailsDynamicContent(t).then(function(r){e.renderItemDetailsDynamicContent(r,t)},function(r){var n=typeof r.responseJSON<"u"&&typeof r.responseJSON.error<"u"?r.responseJSON.error:"Unbekannter Fehler";alert("Fehler beim Laden der Detail-Informationen: "+n)})},renderItemDetailsDynamicContent:function(t,r){if(!t.hasOwnProperty("data")||t.data===!1){e.hideDetails(),window.location.href=r.link;return}var n=t.data,a=e.storage.$details,s=i("<h1>").html(n.title);if(a.html("").append(s),n.hasOwnProperty("attachments")){var o=e.generateDetailAttachments(n.attachments);a.append(o)}e.showDetails()},fetchItemDetailsDynamicContent:function(t){return i.ajax({url:"index.php?module=supersearch&action=ajax&cmd=detail",method:"post",dataType:"json",data:{detail_group:t.group,detail_identifier:t.identifier},error:function(r,n,a){var s="SuperSearch - Unbekannter Fehler #32: "+a;n==="error"&&(s="SuperSearch - Unbekannter Server-Fehler beim Laden des Detail-Ergebnisses: ",s+=a),r.hasOwnProperty("responseJSON")&&r.responseJSON.hasOwnProperty("error")&&(s="SuperSearch - Server-Fehler beim Laden des Detail-Ergebnisses: ",s+=r.responseJSON.error),alert(s)}})},generateDetailAttachments:function(t){var r=i("<div>");return i.each(t,function(n,a){if(!a.hasOwnProperty("type")){console.error('Attachment ung端ltig. "type"-Property fehlt.');return}if(!a.hasOwnProperty("data")){console.error('Attachment ung端ltig. "data"-Property fehlt.');return}if(a.type==="button_block"){var s=e.generateDetailAttachmentTypeButtonBlock(a.data);r.append(s)}if(a.type==="content_static"){var o=e.generateDetailAttachmentTypeStaticContent(a.data);r.append(o)}if(a.type==="content_dynamic"){var l=e.generateDetailAttachmentTypeDynamicContent(a.data);r.append(l)}}),r},generateDetailAttachmentTypeButtonBlock:function(t){var r=i("<div>");return i.each(t,function(n,a){var s=i("<a>").text(a.title).addClass("button");a.hasOwnProperty("attributes")&&i.each(a.attributes,function(o,l){if(o==="class"){s.addClass(l);return}if(o==="data-icon"){var u="";switch(l){case"help":u="./themes/new/images/help.svg";break;case"settings":u="./themes/new/images/settings.svg";break}if(u!==""){s.addClass("icon"),s.addClass("icon-"+l);var d=i('<img alt="Handbuch">').attr("src",u),c=i('<span class="icon">').append(d);s.prepend(c)}}s.attr(o,l)}),s.appendTo(r)}),r},generateDetailAttachmentTypeStaticContent:function(t){return i("<p>").html(t.content)},generateDetailAttachmentTypeDynamicContent:function(t){var r=i("<div>").addClass("minidetail");return t.hasOwnProperty("url")&&t.url!==null&&e.fetchMiniDetailContent(t.url,t.params).then(function(n){r.html(n),e.storage.$details.append(r)},function(n){var a="Fehler beim Laden der Mini-Details: ";n.hasOwnProperty("responseJSON")&&n.responseJSON.hasOwnProperty("error")?a+=n.responseJSON.error:a+=n.status+" "+n.statusText,i('<div class="error"></div>').text(a).appendTo(e.storage.$details)}),r},fetchMiniDetailContent:function(t,r){if(t.substr(0,10)!=="index.php?")throw alert("Mini-Detail-URL ist ung端ltig: "+t),"Mini-Detail-URL ist ung端ltig: "+t;return typeof r!="object"&&(r={}),i.ajax({url:t,data:r,method:"post",dataType:"html"})},showResults:function(){e.getOverlay().addClass("has-result"),e.getOverlay().find("section.empty-message").hide(),e.getOverlay().find("section.error-message").hide()},hideResults:function(){e.getOverlay().removeClass("has-result"),e.getOverlay().find("section.empty-message").hide(),e.getOverlay().find("section.error-message").hide(),e.getOverlay().find("section.last-update").hide()},showDetails:function(){e.getOverlay().addClass("has-detail"),e.getOverlay().find(".detail-wrapper").scrollTop(0)},hideDetails:function(){e.getOverlay().removeClass("has-detail")},showEmptyResults:function(){e.showOverlay(),e.hideDetails(),e.getOverlay().removeClass("has-result"),e.getOverlay().find("section.empty-message").show(),e.getOverlay().find("section.error-message").hide()},showErrorMessage:function(t){e.showOverlay(),e.hideDetails(),e.getOverlay().find("section.empty-message").hide(),e.getOverlay().find("section.error-message").html(t).show()},debounce:function(t,r,n){var a=typeof n<"u"&&n!==null?n:this,s=arguments;window.clearTimeout(e.storage.debounceBuffer),e.storage.debounceBuffer=window.setTimeout(function(){t.apply(a,s)},r||250)}};return{init:e.init}}(jQuery);$(function(){p.init()});
