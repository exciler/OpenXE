var c=function(a){var e={isInitialized:!1,isImporter:!1,debugMode:!1,storage:{$backupDialog:null,$createItemDialog:null},init:function(){if(e.isInitialized!==!0){if(e.storage.$backupDialog=a("#backupModal"),e.storage.$createItemDialog=a("#add-backup"),e.storage.$createItemDialog.length===0)throw"Could not initialize DataTableLabelsUi. Required elements are missing.";e.initDialog(),e.addDialog(),e.registerEvents(),e.isInitialized=!0}},enableDebugMode:function(){e.debugMode=!0,console.log("Debug mode enabled!")},disableDebugMode:function(){e.debugMode=!1,console.log("Debug mode disabled!")},setInterval:function(){return setInterval(function(){e.readStatus()},5e3)},initDialog:function(){e.storage.$backupDialog.dialog({modal:!0,bgiframe:!0,closeOnEscape:!1,minWidth:700,maxHeight:700,autoOpen:!1,buttons:{ABBRECHEN:function(){a(this).dialog("close")},SPEICHERN:{text:"WIEDERHERSTELLEN",id:"run-recovery-btn",click:function(){var t=a(this).data("bid");if(!a("#recovery-migration").hasClass("invisible")&&a("#do-migration").prop("checked")===!0&&a("#old-dbname").val().replace(/\s/g,"")===""){alert("Bitte angeben: Alter Datenbankname !");return}a(this).dialog("close");var i=e.setInterval();e.runRecovery(t,i)}}},open:function(t,i){},close:function(t,i){}})},registerEvents:function(){a(document).on("click","#recover-backup",function(t){t.preventDefault();var i=a(this).data("id");e.backupRecovery(i)}),a("#no-migration").on("click",function(t){a(this).prop("checked",!0),a("#do-migration").prop("checked",!1),e.hideMigrationDbFieldName()}),a("#do-migration").on("click",function(t){a(this).prop("checked",!0),a("#no-migration").prop("checked",!1),e.showMigrationDbFieldName()}),a(".remove-backup").on("click",function(t){t.preventDefault();var i=a(this).data("url");typeof i<"u"&&e.confirmDelete(i)}),a("#create-backup").on("click",function(t){t.preventDefault(),e.createItem()})},reloadUrl:function(t){e.debugMode===!1?window.location.href="index.php?module=backup&action=list&msg="+t:console.log("JOB done! But No Redirect. Debug mode has been enabled!")},showMigrationSetting:function(){a("#recovery-migration").removeClass("invisible")},showMigrationDbFieldName:function(){a("#tr-old-dbname").removeClass("invisible")},hideMigrationDbFieldName:function(){a("#tr-old-dbname").addClass("invisible")},backupRecovery:function(t){var i=parseInt(t);return isNaN(i)||i<=0||(e.setCacheBackup(i,"bid"),a.ajax({url:"index.php?module=backup&action=recover&cmd=check-meta",data:{id:i},method:"post",dataType:"json",beforeSend:function(){App.loading.open()},success:function(n){if(e.storage.$backupDialog.dialog("open"),n.status===!1){if(typeof n.missing_file<"u"&&n.missing_file===!0){e.storage.$backupDialog.dialog("close"),e.reloadUrl(n.message);return}a("#backupModalTimer").addClass("invisible").loadingOverlay("remove"),a("#bck-message").addClass("error").html(n.message),e.showMigrationSetting()}else a("#bck-message").addClass("warning").html(n.message),e.showMigrationSetting();n.ps_message.replace(/\s/g,"")!==""&&a("#bck-ps-message").addClass("error").append(n.ps_message)},error:function(n,r,o){alert("Backup konnte nicht hergestellt werden.")}})),!1},setCacheBackup:function(t,i){a("#backupModal").attr("data-"+i,t)},getCacheBackupValue:function(t){return typeof a("#backupModal").data(t)<"u"?a("#backupModal").data(t):null},runRecovery:function(t,i){a("#run-recovery-btn").prop("disabled",!0),e.setCacheBackup(i,"refresh"),a("#backupModalTimer").removeClass("invisible").loadingOverlay("show").dialog({modal:!0,minWidth:1200,resizable:!1,closeOnEscape:!1,dialogClass:"no-titlebar",open:function(r,o){a(".ui-dialog-titlebar").hide(),a("#backupModalTimer").css({overflow:"hidden"})}});var n={id:t};a("#do-migration").prop("checked")===!0&&a("#old-dbname").val().replace(/\s/g,"")!==""&&(n.old_db=a("#old-dbname").val()),a.ajax({url:"index.php?module=backup&action=recover",data:n,method:"post",dataType:"json",success:function(r){r.status===!1?(clearInterval(i),e.reloadUrl(r.message)):typeof r.file_name<"u"?(e.setCacheBackup(r.generic_error,"generic_error"),e.setCacheBackup(r.file_name,"filename")):typeof r.created_at<"u"&&e.setCacheBackup(r.created_at,"created_at")},error:function(r,o,s){alert("Backup konnte nicht hergestellt werden.")}})},readStatus:function(){var t=e.getCacheBackupValue("filename"),i={};t!=null&&(i.file_name=t);var n=e.getCacheBackupValue("created_at");n!=null&&(i.created_at=n);var r=e.getCacheBackupValue("backup_file");r!=null&&(i.backup_file=r),a.ajax({url:"index.php?module=backup&action=readstatus",data:i,method:"post",dataType:"json",success:function(o){if(o.finished===!0){var s=e.getCacheBackupValue("refresh");s&&clearInterval(s),e.reloadUrl(o.message)}a(".bck-status-message").length>0?(a(".bck-status-message").hasClass("hide")&&a(".bck-status-message").removeClass("hide"),o.finished===!1&&a("#live-status").length>0&&a("#live-status").html(a.trim(o.message)+" ...")):a("#backupModalTimer div.loading-back").after('<div class="bck-status-message hide"><p id="live-status"></p></div>')},error:function(o,s,u){var l=e.getCacheBackupValue("refresh"),d=e.getCacheBackupValue("generic_error");l&&clearInterval(l),e.debugMode===!0&&alert(`Debug Mode::
`+u),e.reloadUrl(d)}})},createItem:function(){if(e.isInitialized===!1&&e.init(),e.storage.$backupDialog.length===0)throw"Could not initialize DataTableLabelsUi. Required elements are missing.";if(a(".backup-success").length>0){alert("Entfernen Sie bitte zuerst das Letzte Backup !");return}e.resetAdd(),e.storage.$createItemDialog.dialog("open")},hasProcessStarterEnabled:function(){return!0},showProcessStarterMissingError:function(){var t='Es sieht so aus, als ob der Prozessstarter Cronjob nicht regelm&auml;&szlig;ig ausgef&uuml;hrt wird! Bitte aktivieren Sie diesen (<a href="http://helpdesk.wawision.de/doku.php?id=entwickler:grundinstallation#einrichten_des_heartbeat-cronjobs_optional" target="_blank">Link zu Helpdesk</a>)!';e.storage.$backupDialog.dialog("open"),a("#run-recovery-btn").hide(),a("#bck-message").addClass("error").html(t)},addDialog:function(){e.storage.$createItemDialog.dialog({modal:!0,bgiframe:!0,closeOnEscape:!1,minWidth:650,maxHeight:700,autoOpen:!1,buttons:{ABBRECHEN:function(){e.resetAdd(),a(this).dialog("close")},SPEICHERN:function(){e.saveItem(),a(this).dialog("close")}}})},saveItem:function(){var t=e.setInterval();e.setCacheBackup(t,"refresh"),a("#backupModalTimer").removeClass("invisible").loadingOverlay("show").dialog({modal:!0,minWidth:1200,resizable:!1,closeOnEscape:!1,dialogClass:"no-titlebar",open:function(i,n){a(".ui-dialog-titlebar").hide(),a("#backupModalTimer").css({overflow:"hidden"})}}),a.ajax({url:"index.php?module=backup&action=create",data:{name:a("#b_name").val()},method:"post",dataType:"json",beforeSend:function(){App.loading.open()},success:function(i){App.loading.close(),i.status===!1&&e.reloadUrl(i.message),e.reloadUrl(i.success_msg),e.setCacheBackup(i.generic_error,"generic_error"),typeof i.created_at<"u"&&e.setCacheBackup(i.created_at,"created_at"),typeof i.backup_file<"u"&&e.setCacheBackup(i.backup_file,"backup_file")},error:function(i,n,r){alert("Backup konnte nicht angelegt werden. ")}})},resetAdd:function(){a("#add-backup").find("#b_name").val("")},backupImporter:{isInitialized:!1,registerEvents:function(){a("#input-for-backup-importer").on("click",function(t){t.preventDefault(),a("#backup-importer").click()})},init:function(){e.backupImporter.registerEvents(),e.backupImporter.isInitialized!==!0&&(a("#backup-importer").chunkedUpload({upload:{url:"index.php?module=backup&action=importer&cmd=upload"},fileComplete:function(t){if(typeof t.name>"u")throw"File name is missing!";a.ajax({url:"index.php?module=backup&action=importer&cmd=completed",data:{file_name:t.name},method:"post",dataType:"json",beforeSend:function(){App.loading.open()},success:function(i){App.loading.close(),i.status===!1&&e.reloadUrl(i.message)},error:function(i,n,r){alert("Backup konnte nicht importiert werden")}})}}),e.backupImporter.isInitialized=!0)}},confirmDelete:function(t){if(!confirm("Soll der Backup Eintrag wirklich gelÃ¶scht werden?"))return!1;window.location.href=t}};return{init:e.init,enableDebug:e.enableDebugMode,disableDebug:e.disableDebugMode,import:e.backupImporter.init}}(jQuery);$(function(){$("#backupModal").length>0,c.init(),$("#backup-importer").length>0&&c.import()});
