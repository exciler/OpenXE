var u=function(a,c){var e={settings:{fetchMessageInterval:2e3,fetchUserlistInterval:15e3,lazyLoadingBufferTime:250,newTimeout:5e3},selector:{messageArea:"#message-area",inputField:"#nachricht",userList:"#userlist",roomList:"#roomlist",roomName:"#message-header",chatForm:"#chatform",prioCheckbox:"#prio",notificationInfo:"#notification-info",wawiSidebar:"#sidebar"},storage:{activeUserId:0,selfUserId:0,newestMessageId:0,oldestMessageId:null,newestReadmarkId:0,requestBuffer:0,requestEOF:!1,readMark:[],newestDateString:"",oldestDateString:"",dateStrings:[],isStandaloneWindow:null,fetchMessageInterval:null,fetchUserlistInterval:null},elem:{$window:null,$wrapper:null,$sidebarWrapper:null,$sidebarScroller:null,$messageWrapper:null,$messageScroller:null},init:function(){if(e.storage.isStandaloneWindow=a(e.selector.wawiSidebar).length===0,e.elem.$window=a(window),e.elem.$wrapper=a("#chat-wrapper"),e.elem.$messageWrapper=a("#message-wrapper"),e.elem.$messageScroller=a("#message-scroller"),e.elem.$sidebarWrapper=a("#sidebar-wrapper"),e.elem.$sidebarScroller=a("#sidebar-scroller"),e.checkNotificationPermission(),e.resizeElements(),e.attachEvents(),e.switchToUser(0),e.storage.isStandaloneWindow){var s='<div id="submenu-wrapper" class="clearfix"><div class="back">';s+='<a href="index.php?module=welcome&action=start"><svg xmlns="http://www.w3.org/2000/svg" width="7px" height="12px" viewBox="0 0 131.99 218.57"><path fill="none" stroke="#fff" stroke-miterlimit="10" stroke-width="33" d="M120.26 11.65l-97 97.21 97 98.11"/></svg></a>',s+='</div><a href="index.php?module=welcome&action=start" style="display:block;padding: 7px 20px;">Zurück zur Startseite</a>',s+="</div>",a("#tabs").prepend(s)}},attachEvents:function(){a(e.selector.chatForm).on("submit",function(s){s.preventDefault(),e.sendMessage(a(e.selector.inputField).val(),a(e.selector.prioCheckbox).prop("checked"))}),a(document).on("click",e.selector.userList+" li",function(s){s.preventDefault(),e.switchToUser(parseInt(a(this).data("user-id")))}),a(document).on("click",e.selector.roomList+" li",function(s){s.preventDefault(),e.switchToUser(parseInt(a(this).data("user-id")))}),a(document).on("click",e.selector.notificationInfo,function(){e.requestNotificationPermission()}),a(window).on("resize",function(){e.debounce(e.resizeElements,100)})},start:function(){e.storage.fetchUserlistInterval=setInterval(function(){e.updateUserList()},e.settings.fetchUserlistInterval),e.storage.fetchMessageInterval=setInterval(function(){e.fetchNewMessages(!1),e.setMessagesAsRead()},e.settings.fetchMessageInterval)},stop:function(){clearInterval(e.storage.fetchMessageInterval),clearInterval(e.storage.fetchUserlistInterval)},checkNotificationPermission:function(){var s=c.Permission.get();if(s===c.Permission.DEFAULT){var r='<div class="info" id="notification-info"><table width="100%" border="0" cellpadding="0" cellspacing="0"><tr><td>Aktuell können keine Browser-Benachrichtigungen zugestellt werden. Bitte Klicken Sie hier um die Nachrichten für Xentral zu erlauben.</td><td align="right"><input type="button" id="notification-button" value="Benachrichtigungen erlauben"></td></tr></table></div>';a("#tabs-1").prepend(r)}},requestNotificationPermission:function(){c.Permission.request(e.removeNotificationInfoBox,e.removeNotificationInfoBox)},removeNotificationInfoBox:function(){a(e.selector.notificationInfo).remove(),e.resizeElements()},sendMessage:function(s,r){(typeof r>"u"||typeof r!="boolean")&&(r=!1),a.ajax({type:"POST",url:"index.php?module=chat&action=list&cmd=sendmessage",data:{nachricht:s,empfaenger:e.storage.activeUserId,prio:r===!0?"1":"0"},success:function(){e.emptyInput(),e.focusInput(),e.fetchNewMessages(!0)}})},updateUserList:function(){a.ajax({type:"POST",dataType:"json",url:"index.php?module=chat&action=list&cmd=userlist",success:function(s){e.renderUserList(s.users),e.renderRoomList(s.rooms)}})},renderUserList:function(s){var r="<ul>";a(s).each(function(i,t){if(t.id=parseInt(t.id),t.self===!0){e.storage.selfUserId=t.id;return}if(t.id===e.storage.activeUserId){var o='<img src="index.php?module=ajax&action=profilbild&id='+t.id+'" alt="'+t.name+'">';o+="<span>Mit "+t.name+"</span>",a(e.selector.roomName).html(o).removeClass("public")}var n=t.online===!0?"online":"";n+=t.id===e.storage.activeUserId?" active":"",r+='<li class="'+n+'" data-user-id="'+t.id+'">',r+='<span class="name">'+t.name+"</span> ",t.unread>0&&(r+='<span class="'+(t.unread>0?"unread":"")+'">('+t.unread+")</span>"),r+="</li>"}),r+="</ul>",a(e.selector.userList).html(r)},renderRoomList:function(s){var r="<ul>";a(s).each(function(i,t){var o=t.id===e.storage.activeUserId?" active":"";t.id===e.storage.activeUserId&&a(e.selector.roomName).html("<span>"+t.name+"</span>").addClass("public"),r+='<li class="'+o+'" data-user-id="'+t.id+'">',r+='<span class="name">'+t.name+"</span> ",t.unread>0&&(r+='<span class="'+(t.unread>0?"unread":"")+'">('+t.unread+")</span>"),r+="</li>"}),r+="</ul>",a(e.selector.roomList).html(r)},fetchNewMessages:function(s){(typeof s>"u"||typeof s!="boolean")&&(s=!1),a.ajax({type:"POST",url:"index.php?module=chat&action=list&cmd=messages",data:{user_id:e.storage.activeUserId,after_message_id:e.storage.newestMessageId,after_readmark_id:e.storage.newestReadmarkId},success:function(r){e.renderNewMessages(r.messages),e.renderMessagesAsRead(r.readmark),s===!0&&e.scrollToLatestMessage()}})},setMessagesAsRead:function(){e.storage.readMark.length!==0&&a.ajax({type:"POST",url:"index.php?module=chat&action=list&cmd=markread",data:{messages:e.storage.readMark},success:function(s){a(s).each(function(r,i){i=parseInt(i);var t=e.storage.readMark.indexOf(i);t!==-1&&e.storage.readMark.splice(t,1)})}})},renderMessagesAsRead:function(s){s.length!==0&&(e.isPublicChat()||a(s).each(function(r,i){i.id>e.storage.newestReadmarkId&&(e.storage.newestReadmarkId=i.id),a(e.selector.messageArea).find("#message-"+i.message).removeClass("unread").addClass("read")}))},fetchOldMessages:function(){e.storage.requestEOF!==!0&&(e.storage.requestBuffer>window.performance.now()||(e.storage.requestBuffer=window.performance.now()+e.settings.lazyLoadingBufferTime,a.ajax({type:"POST",url:"index.php?module=chat&action=list&cmd=messages",data:{user_id:e.storage.activeUserId,before_message_id:e.storage.oldestMessageId},success:function(s){if(s.messages.length===0){e.renderDateString(e.storage.oldestDateString,"DESC",!0),e.storage.requestEOF=!0;return}e.renderOldMessages(s.messages)}})))},renderNewMessages:function(s){var r=!1;s.length!==0&&(e.storage.oldestMessageId===null&&(e.storage.oldestMessageId=s[0].id),a(s).each(function(i,t){e.renderDateString(t.date,"ASC",!1),e.renderSingleMessage(t,"ASC"),r=!0,t.read===!1&&e.reserveMessageForReadMark(t)}),r===!0&&(e.scrollToLatestMessage(),setTimeout(function(){e.enableScrollSpy()},100)))},renderOldMessages:function(s){var r=a(e.selector.messageArea).height();s=s.reverse(),a(s).each(function(o,n){e.renderDateString(n.date,"DESC",!1),e.renderSingleMessage(n,"DESC"),n.read===!1&&e.reserveMessageForReadMark(n)});var i=a(e.selector.messageArea).height(),t=i-r-20;e.elem.$messageScroller.scrollTop(t)},reserveMessageForReadMark:function(s){s.read!==!0&&(e.isPrivateChat()&&!e.isOwnMessage(s.user)&&e.storage.readMark.push(s.id),e.isPublicChat()&&e.storage.readMark.push(s.id))},renderSingleMessage:function(s,r){if(!(a("#message-"+s.id).length>0)){var i="message";e.isPrivateChat()&&e.isOwnMessage(s.user)&&(s.read===!1&&(i+=" unread"),s.read===!0&&(i+=" read")),e.isOwnMessage(s.user)||s.read===!1&&(i+=" new"),s.prio===!0&&(i+=" prio");var t='<div data-id="{{id}}" id="{{elementId}}" class="{{classes}}">  <div class="image">    <img src="index.php?module=ajax&action=profilbild&id={{user}}" alt="{{alt}}">  </div>  <div class="head">    <span class="sender">{{name}}</span>    <span class="time">{{time}}</span>  </div>  <div class="text">{{text}}</div></div>';t=t.replace("{{id}}",s.id),t=t.replace("{{user}}",s.user),t=t.replace("{{alt}}",s.name),t=t.replace("{{name}}",s.name),t=t.replace("{{time}}",s.time),t=t.replace("{{text}}",s.text),t=t.replace("{{classes}}",i),t=t.replace("{{elementId}}","message-"+s.id),r==="ASC"&&a(e.selector.messageArea).append(t),r==="DESC"&&a(e.selector.messageArea).prepend(t),setTimeout(function(){a("#message-"+s.id+".new").removeClass("new")},e.settings.newTimeout),s.id>e.storage.newestMessageId&&(e.storage.newestMessageId=s.id),s.id<e.storage.oldestMessageId&&(e.storage.oldestMessageId=s.id)}},renderDateString:function(s,r,i){(typeof r>"u"||typeof r!="string")&&(r="ASC"),(typeof i>"u"||typeof i!="boolean")&&(i=!1),e.storage.dateStrings.indexOf(s)===-1&&(e.storage.dateStrings.push(s),e.storage.newestDateString===""&&(e.storage.newestDateString=s),e.storage.oldestDateString===""&&(e.storage.oldestDateString=s),r==="ASC"&&e.storage.newestDateString!==s&&(a(e.selector.messageArea).append('<div class="date"><span>'+s+"</span></div>"),e.storage.newestDateString=s),r==="DESC"&&(e.storage.oldestDateString!==s||i===!0)&&(a(e.selector.messageArea).prepend('<div class="date"><span>'+e.storage.oldestDateString+"</span></div>"),e.storage.oldestDateString=s))},scrollToLatestMessage:function(){e.elem.$messageScroller.animate({scrollTop:e.elem.$messageScroller.get(0).scrollHeight},100)},switchToUser:function(s){e.storage.activeUserId=s,e.storage.newestMessageId=0,e.storage.oldestMessageId=null,e.storage.oldestDateString="",e.storage.newestDateString="",e.storage.newestReadmarkId=0,e.storage.readMark=[],e.storage.dateStrings=[],e.storage.requestBuffer=0,e.storage.requestEOF=!1,e.stop(),e.updateUserList(),e.emptyMessageArea(),e.fetchNewMessages(!0),e.emptyInput(),e.focusInput(),window.setTimeout(function(){e.start()},2e3)},resizeElements:function(){var s=e.elem.$window.height(),r=e.elem.$wrapper.width(),i=e.elem.$sidebarWrapper.outerWidth(),t=a(e.selector.notificationInfo),o=t.outerHeight()!==null?t.outerHeight()+10:0,n=0,l=0,d=0;e.storage.isStandaloneWindow?(n=r-i-10,l=s-200,d=s-90):(n=r-i-10,l=s-360,d=s-240),l-=o,d-=o,e.elem.$messageScroller.width(n),e.elem.$messageScroller.height(l),e.elem.$sidebarScroller.height(d)},enableScrollSpy:function(){var s=e.elem.$messageScroller.height()<a(e.selector.messageArea).height();s!==!1&&e.elem.$messageScroller.on("scroll",function(){var r=a(this).scrollTop();r<50&&e.fetchOldMessages()})},disableScrollSpy:function(){e.elem.$messageScroller.off("scroll")},focusInput:function(){a(e.selector.inputField).trigger("focus")},emptyInput:function(){a(e.selector.inputField).val("")},emptyMessageArea:function(){e.disableScrollSpy(),a(e.selector.messageArea).empty()},isPublicChat:function(){return e.storage.activeUserId===0},isPrivateChat:function(){return e.storage.activeUserId>0},isOwnMessage:function(s){return s===e.storage.selfUserId},debounce:function(s,r){var i=this,t=arguments;window.clearTimeout(e.storage.buffer),e.storage.buffer=window.setTimeout(function(){s.apply(i,t)},r||250)}};return{init:e.init,start:e.start,stop:e.stop}}(jQuery,Push);$(document).ready(function(){u.init()});
